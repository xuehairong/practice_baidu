<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div id="cash"></div>

    <script>
        var cashWrapper = document.getElementById("cash");
        //ES5
        Array.prototype.remove = function(val) {
            var index = this.indexOf(val);
            if (index > -1) {
                this.splice(index, 1);
            }
        };

        function Restaurant(obj) {
            this.cash = obj.cash;
            this.seats = obj.seats;
            this.staff = obj.staff;
        }
        Restaurant.prototype.hire = function(newStaff) {
            this.staff.push(newStaff);
        }
        Restaurant.prototype.fire = function(oldStaff) {
            this.staff.remove(oldStaff);
        }

        function Staff(name, wage) {
            // this.id = id;
            this.name = name;
            this.wage = wage;
        }
        Staff.prototype.work = function(job) {
                console.log(this.name + '完成一次工作：' + job);
            }
            //服务员类
        function Waiter(name, wage) {

            Staff.call(this, name, wage);
            this.instance = null;
        }
        Waiter.prototype = Object.create(Staff.prototype);
        Waiter.prototype.constuctor = Waiter;
        Waiter.prototype.work = function(job) {
            var jobContent = "上菜行为";
            if (Array.isArray(job)) {
                jobContent = "记录客人点菜";
            }
            console.log('服务员' + this.name + jobContent);
        }
        Waiter.getInstance = function(name, wage) {
                if (!this.instance) {
                    this.instance = new Waiter(name, wage);
                }
                return this.instance;
            }
            //厨师类
        function Cook(name, wage) {
            Staff.call(this, name, wage);
            this.instance = null;
        }
        Cook.prototype = Object.create(Staff.prototype);
        Cook.prototype.constuctor = Cook;
        Cook.prototype.work = function(food) {
            return new Promise(function(resolve, reject) {
                setTimeout(function() {
                    console.log('厨师' + this.name + '正在烧' + food.name + '(' + food.time + 's)...');
                    return (resolve(food));
                }, food.time * timeUnit);
            })

        }
        Cook.getInstance = function(name, wage) {
                if (!this.instance) {
                    this.instance = new Cook(name, wage);
                }
                return this.instance;
            }
            //顾客类
        function Customer(name) {
            this.name = name;
        }

        Customer.prototype.order = function() {
            return new Promise(function(resolve, reject) {
                console.log("顾客" + this.name + "正在点菜中(3s)...");
                setTimeout(function() {
                    var foodList = [];
                    var count = Math.round(Math.random() * (foods.length - 1))
                    while (count > 0) {
                        var i = Math.round(Math.random() * (foods.length - 1));
                        foodList.push(foods[i]);
                        count--;
                    }
                    resolve(foodList);
                }, 3 * timeUnit);
            });
        }
        Customer.prototype.eat = function(food) {
            return new Promise(function(resolve, reject) {
                console.log("顾客" + this.name + "正在吃" + food.name + "(3s...)");
                setTimeout(() => {
                    resolve(food);
                }, 3 * timeUnit);
            })
        }

        function Food(name, cost, price) {
            this.name = name;
            this.cost = cost;
            this.price = price;
        }
        /**开始运作餐厅**/
        var timeUnit = 1000; //时间单位为1秒
        function delaytime(count) {
            var time_1 = new Date();
            while (new Date() - time_1 < (timeUnit * count));
        }
        var Customers = ['a', 'b', 'c', 'd'];
        var foods = [{
            name: "红烧肉",
            price: 25,
            time: 2
        }, {
            name: "土豆丝",
            price: 15,
            time: 1
        }, {
            name: "青菜",
            price: 10,
            time: 1
        }, {
            name: "鸡腿",
            price: 20,
            time: 2
        }];
        var ifeRestaurant = new Restaurant({
            cash: 0,
            seats: 1,
            staff: []
        });
        //入座
        function sitdown(customerName) {
            ifeRestaurant.seats--;
            console.log(customerName + "入座,剩余座位：" + ifeRestaurant.seats);
        }

        function payBill(food) {
            ifeRestaurant.cash += parseFloat(food.price);
            cashWrapper.innerHTML = ifeRestaurant.cash;
            // console.log("餐厅收入为：" + ifeRestaurant.cash);
            ifeRestaurant.seats++;
            console.log("剩余座位：" + ifeRestaurant.seats);
        }



        var newCook = Cook.getInstance("Tony", 10000);
        ifeRestaurant.hire(newCook);
        var newWaiter = Waiter.getInstance("waiter1", 8000);
        ifeRestaurant.hire(newWaiter);

        while (Customers.length > 0 && ifeRestaurant.seats > 0) {
            var customer = new Customer(Customers[0]);
            // var food = orderFood();
            //入座
            sitdown(customer.name);
            //点菜
            var order = customer.order();
            order.then(function(foodList) {
                console.log("顾客点完菜了");
                console.log(foodList);
                newWaiter.work(foodList);
                var count = foodList.length;
                loopCook(0, foodList);
            });

            // newCook.work(food.name);
            // // Waiter.instance.work(food.name);           
            // newWaiter.work('上菜' + food.name);
            // customer.eat(food.name);
            // payBill(food);
            Customers.shift();
        }

        function loopCook(i, foodList) {
            newCook.work(foodList[i]).then(() => {
                newWaiter.work(foodList[i]);
                customer.eat(foodList[i]);
                i++;
                if (i < foodList.length) {
                    loopCook(i, foodList);
                } else {
                    console.log("所有菜品已完成");
                }
            });
        }
    </script>
</body>

</html>